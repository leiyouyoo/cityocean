!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@cityocean/common-library"),require("rxjs/operators"),require("rxjs"),require("lodash"),require("@cityocean/basicdata-library"),require("@cityocean/amap-library")):"function"==typeof define&&define.amd?define("@cityocean/shipment-library",["exports","@angular/core","@cityocean/common-library","rxjs/operators","rxjs","lodash","@cityocean/basicdata-library","@cityocean/amap-library"],e):e(((t=t||self).cityocean=t.cityocean||{},t.cityocean["shipment-library"]={}),t.ng.core,t.commonLibrary,t.rxjs.operators,t.rxjs,t.lodash,t.basicdataLibrary,t.amapLibrary)}(this,(function(t,e,n,r,o,i,a,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var c=function(){return(c=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function u(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{c(r.next(t))}catch(t){i(t)}}function s(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(a,s)}c((r=r.apply(t,e||[])).next())}))}function p(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function l(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,o,i=n.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(t){o={error:t}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function h(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(l(arguments[e]));return t}var f={SellerLocation:0,OriginStopOff:1,InTransitToDeparturePort:2,DeparturePort:3,InTransitToArrivalPort:4,ArrivalPort:5,InTransitToFinalDestination:6,DestinationStopOff:7,FinalDestination:8,Canceled:9,Completed:10};f[f.SellerLocation]="SellerLocation",f[f.OriginStopOff]="OriginStopOff",f[f.InTransitToDeparturePort]="InTransitToDeparturePort",f[f.DeparturePort]="DeparturePort",f[f.InTransitToArrivalPort]="InTransitToArrivalPort",f[f.ArrivalPort]="ArrivalPort",f[f.InTransitToFinalDestination]="InTransitToFinalDestination",f[f.DestinationStopOff]="DestinationStopOff",f[f.FinalDestination]="FinalDestination",f[f.Canceled]="Canceled",f[f.Completed]="Completed";var m=function(){function t(){}return t.prototype.transform=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];switch(t){case f.SellerLocation:return"Seller 's Location / Booked";case f.InTransitToDeparturePort:return"In Transit to Departure Port";case f.DeparturePort:return"Departure Port";case f.InTransitToArrivalPort:return"In Transit to Arrival Port";case f.ArrivalPort:return"Arrival  port";case f.InTransitToFinalDestination:return"In Transit to Final Destination";case f.FinalDestination:return"Final destination";default:return""}},t.decorators=[{type:e.Pipe,args:[{name:"shipmentStatus"}]}],t}(),g=function(){function t(t,e,n){this.http=t,this.amapService=e,this.componentToHtmlService=n}return t.prototype.GetAll=function(t){return this.http.postJson("/CSP/Shipment/GetAllList",t).pipe(r.map((function(t){return t.items.forEach((function(t){t.agreement=0===t.routeDetails.consigneeInfos.length&&0===t.routeDetails.shipperInfos.length?"cy-cy":0===t.routeDetails.shipperInfos.length?"cy-door":0===t.routeDetails.consigneeInfos.length?"door-cy":"door-door",t.transportType=t.freightMethodType===a.FreightMethodType.Ocean?"ship":"air";try{t.shiperShow=t.routeDetails.shipperInfos.length&&t.routeDetails.shipperInfos[0].shipperNetWorkInfo.name||"",t.consigneeShow=t.routeDetails.consigneeInfos.length&&t.routeDetails.consigneeInfos[0].consigneeNetWorkInfo.name||""}catch(t){console.log(t)}t.state=t.status,t.containerList&&(t.containerListShow="",t.containerList.forEach((function(e){t.containerListShow+=e.count+"*"+e.code+" "})))})),t})))},t.prototype.getStatistics=function(){return this.http.get("/CSP/Shipment/GetShipmentsStatistics")},t.prototype.GetDetail=function(t){return this.http.get("/CSP/Shipment/GetDetail",{id:t})},t.prototype.GetShipmentDetail=function(t){return this.http.get("/CSP/Shipment/GetShipmentDetail",{id:t})},t.prototype.getMapShipRoute=function(t){void 0===t&&(t=[]);var e=[],n={coor:[-247.388497,22.551956],iconClass:"icon-icon_oceanshipmentx"},r={coor:[-246.629063,22.594968],iconClass:"icon-icon_oceanshipmentx"},o={coor:[-118.243707,34.053945],iconClass:"icon-icon_oceanshipmentx"},i={ship:"icon-icon_oceanshipmentx",air:"icon-icon_airshipmentx"},a=t.filter((function(t){return t.name.includes("guangzhou")||t.name.includes("angeles")||t.name.includes("yantian")}));return a.length>=1&&(e=a.map((function(t){return t.name.includes("guangzhou")?c({},r,{id:t.id,theme:t.isDanger?"error":"",iconClass:i[t.transportType]}):t.name.includes("angeles")?c({},o,{id:t.id,start:!1,theme:t.isDanger?"error":"",iconClass:i[t.transportType]}):t.name.includes("yantian")?c({},n,{id:t.id,theme:t.isDanger?"error":"",iconClass:i[t.transportType]}):void 0})),a[0]&&a[0].start),{iconList:e,line:[]}},t.prototype.createShare=function(t){return void 0===t&&(t={}),this.http.postJson("/CSP/ShipmentShareLink/Create",t)},t.prototype.getShareHistory=function(t){void 0===t&&(t={});return this.http.get("/CSP/ShipmentShareLink/GetAll",t)},t.prototype.shareSend=function(t){return this.http.put("/CSP/ShipmentShareLink/Update",t)},t.prototype.shareCancel=function(t){return this.http.postJson("/CSP/ShipmentShareLink/Cancel",{id:t})},t.prototype.getShipTrack=function(t){return t.needCount||(t.needCount=100),this.http.get("/PUB/VesselInfos/GetShipTrack?VesselName=CMA%20CGM%20ORFEO&StartTime=12/15/2019%201:00:00%20AM&EndTime=1/19/2020%201:00:00%20AM&needCount=10000").pipe(r.map((function(t){return t.map((function(t){return c({},t,{point:[t.longitudeDegree,t.latitudeDegree]})}))})))},t.prototype.getShipmentTrackByRes=function(t){var e=t.routeDetails;return this.getShipTrack({vesselName:t.vessel,startTime:e.estDepatureOrginPortDate,endTime:e.estArrivalDestinationPortDate})},t.prototype.getAllPortsForOthers=function(t){return this.http.get("/CSP/Shipment/GetAllPortsForOthers",t)},t.prototype.getAllLocationsForOthers=function(t){return this.http.get("/CSP/Shipment/GetAllLocationsForOthers",t)},t.prototype.getAllCompanyForOthers=function(){return this.http.get("/CSP/Shipment/GetAllCompanyForOthers")},t.prototype.createOrUpdateConditionGroup=function(t){return this.http.postJson("/Platform/BusinessFilter/CreateOrUpdateConditionGroup",t)},t.prototype.getShipmentLinkDetail=function(t){var e={Id:t};return this.http.get("/CSP/ShipmentShareLink/GetDetail",e)},t.prototype.getShipmentMapDataByDetails=function(t){var e=this;return o.forkJoin(t.map((function(t){return new Promise((function(n){return u(e,void 0,void 0,(function(){var e,i,s,c,u,h,m,g,d,y,S,v=this;return p(this,(function(p){switch(p.label){case 0:return p.trys.push([0,6,,7]),e=[],i=[],s=[],c=[],u=[t.routeDetails.originPort,t.routeDetails.destinationPort].map((function(t){return t.name+","+t.fullName})),[4,o.forkJoin(u.map((function(t){return v.amapService.googleGeo(t)}))).toPromise()];case 1:return h=p.sent().map((function(t){return[t.geometry.location.lng,t.geometry.location.lat]})),t.freightMethodType!==a.FreightMethodType.Ocean?[3,3]:(e.push({point:h[0],icon:"icon-port"},{point:h[1],icon:"icon-port"}),[4,this.getShipmentTrackByRes(t).pipe(r.map((function(t){return t.map((function(t){return t.point}))}))).toPromise()]);case 2:return(c=p.sent()).length&&t.status===f.InTransitToArrivalPort&&e.push({point:c[c.length-1],icon:"icon-ship-round"}),[3,4];case 3:e.push({point:h[0],icon:"icon-port"},{point:h[1],icon:"icon-port"}),t.status===f.InTransitToArrivalPort&&e.push({point:[c[0][0]+c[1][0],c[0][1]+c[1][1]].map((function(t){return t/2})),icon:"icon-airplane"}),p.label=4;case 4:return c.unshift(h[0]),c.push(h[1]),[f.InTransitToArrivalPort,f.ArrivalPort].includes(t.status)&&i.push(c),s.push(c),[4,Promise.all([o.forkJoin(t.routeDetails.shipperInfos.map((function(t){return v.amapService.googleGeo(t.shipperNetWorkInfo.streetAddress)}))).toPromise(),o.forkJoin(t.routeDetails.consigneeInfos.map((function(t){return v.amapService.googleGeo(t.consigneeNetWorkInfo.streetAddress)}))).toPromise()])];case 5:return m=p.sent(),g=l(m.map((function(t){return t||[]})),2),d=g[0],y=g[1],[d,y].forEach((function(n,r){n.map((function(n){var o=[n.geometry.location.lng,n.geometry.location.lat];switch(e.push({point:o,icon:"icon-warehouse"}),r){case 0:s.push([o,c[0]]),t.status>f.InTransitToDeparturePort?i.push([o,c[0]]):t.status===f.InTransitToDeparturePort&&e.push({point:[o[0]+c[0][0],o[1]+c[0][1]].map((function(t){return t/2})),icon:"icon-truck"});break;case 1:s.push([c[c.length-1],o]),t.status>f.InTransitToFinalDestination?i.push([c[c.length-1],o]):t.status===f.InTransitToFinalDestination&&e.push({point:[o[0]+c[c.length-1][0],o[1]+c[c.length-1][1]].map((function(t){return t/2})),icon:"icon-truck"})}}))})),n({icons:e,lines:i,dashedLines:s}),[3,7];case 6:return S=p.sent(),console.error(S),n(null),[3,7];case 7:return[2]}}))}))}))}))).pipe(r.map((function(t){return t.filter((function(t){return t}))})))},t.prototype.getIconListByDetails=function(t){var e=this,n=function(t,n,r){return{point:[t.geometry.location.lng+.008*Math.random()-.004,t.geometry.location.lat+.008*Math.random()-.004],template:e.componentToHtmlService.getShipmentTemplate(r),icon:n,data:r}},s=function(t,o){return e.amapService.googleGeo(t.name+" "+t.fullName).pipe(r.map((function(t){return n(t,o.freightMethodType===a.FreightMethodType.Ocean?"icon-ship-round":"icon-airplane",o)}))).toPromise()},c=function(t){return u(e,void 0,void 0,(function(){var e,n,r=this;return p(this,(function(i){switch(i.label){case 0:return e=[t.routeDetails.originPort,t.routeDetails.destinationPort].map((function(t){return t.name+","+t.fullName})),[4,o.forkJoin(e.map((function(t){return r.amapService.googleGeo(t)}))).toPromise()];case 1:return n=i.sent().map((function(t){return[t.geometry.location.lng,t.geometry.location.lat]})),[2,{point:n.reduce((function(t,e){return t.map((function(t,n){return t+e[n]}))})).map((function(t){return t/2})),icon:"icon-airplane",template:this.componentToHtmlService.getShipmentTemplate(t),data:t}]}}))}))},l=function(t,r,i){return u(e,void 0,void 0,(function(){var e,a,s=this;return p(this,(function(c){switch(c.label){case 0:return[4,o.forkJoin(t.map((function(t){return s.amapService.googleGeo(t.shipperNetWorkInfo.streetAddress)}))).toPromise()];case 1:return e=c.sent(),[4,this.amapService.googleGeo(r.name+","+r.fullname).toPromise()];case 2:return a=c.sent(),[2,e.map((function(t){return t.geometry.location.lng=(t.geometry.location.lng+a.geometry.location.lng)/2,t.geometry.location.lat=(t.geometry.location.lat+a.geometry.location.lat)/2,n(t,"icon-truck",i)}))]}}))}))};return o.forkJoin(t.map((function(t){return u(e,void 0,void 0,(function(){var e=this;return p(this,(function(i){try{switch(t.routeDetails.originPort,t.routeDetails.destinationPort,t.status){case f.SellerLocation:case f.OriginStopOff:case f.InTransitToDeparturePort:return[2,o.forkJoin(t.routeDetails.shipperInfos.map((function(t){return e.amapService.googleGeo(t.shipperNetWorkInfo.streetAddress)}))).pipe(r.map((function(e){return e.map((function(e){return n(e,"icon-warehouse-round",t)}))}))).toPromise()];case f.DeparturePort:return[2,s(t.routeDetails.originPort,t)];case f.InTransitToArrivalPort:return[2,t.freightMethodType===a.FreightMethodType.Ocean?this.getShipmentTrackByRes(t).pipe(r.map((function(e){return e.length?n({geometry:{location:{lng:e[length-1].point[0],lat:e[length-1].point[1]}}},"icon-ship-round",t):s(t.routeDetails.originPort,t)}))).toPromise():c(t)];case f.ArrivalPort:return[2,s(t.routeDetails.destinationPort,t)];case f.InTransitToFinalDestination:return[2,l(t.routeDetails.consigneeInfos,t.routeDetails.destinationPort,t)];case f.FinalDestination:return[2,o.forkJoin(t.routeDetails.consigneeInfos.map((function(t){return e.amapService.googleGeo(t.consigneeNetWorkInfo.streetAddress)}))).pipe(r.map((function(e){return e.map((function(e){return n(e,"icon-warehouse-round",t)}))}))).toPromise()]}}catch(t){return console.error(t),[2,[]]}return[2]}))}))}))).pipe(r.catchError((function(t){return console.error(t),o.of([])})),r.map((function(t){return i.flatten(t)})))},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:n.HttpService},{type:s.AmapService},{type:s.ComponentToHtmlService}]},t.ngInjectableDef=e.ɵɵdefineInjectable({factory:function(){return new t(e.ɵɵinject(n.HttpService),e.ɵɵinject(s.AmapService),e.ɵɵinject(s.ComponentToHtmlService))},token:t,providedIn:"root"}),t}();var d=[m],y=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{declarations:h(d),imports:[],exports:h(d)}]}],t}();t.ShipmentLibraryModule=y,t.ShipmentService=g,t.ShipmentStatusEnum=f,t.shipmentStatus={0:"Seller 's Location / Booked",1:"In Transit to Departure Port",2:"Departure Port",3:"In Transit to Arrival Port",4:"Arrival  port",5:"In Transit to Final Destination",6:"Final destination"},t.ɵa=m,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=cityocean-shipment-library.umd.min.js.map